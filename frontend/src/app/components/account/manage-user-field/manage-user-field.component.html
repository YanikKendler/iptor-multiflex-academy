<div class="user" *ngIf="!root">
  <div class="top" (click)="toggle($event)">
    @if (userTree.userId != this.userService.currentUser.value.userId) {
      <p class="username">{{ userTree.username }}</p>
    }

    <div>
      <app-icon-button class="statistics" [cdkMenuTriggerFor]="statistics" (click)="$event.stopPropagation()">
        <fa-icon [icon]="faChartSimple"></fa-icon>
      </app-icon-button>
      <fa-icon [icon]="faAngleDown" [ngClass]="isExpanded ? 'rotate' : ''"></fa-icon>
    </div>

    <ng-template #statistics>
      <div class="stats" cdkMenu>
        <h2>{{userTree.username}}</h2>

        <p>
          <span class="title">Videos watched</span> <span class="stat">{{ userStatistics.totalVideosWatched }}</span>
        </p>
        <p>
          <span class="title">Learning Paths completed</span> <span class="stat">{{ userStatistics.totalLearningPathsCompleted }}</span>
        </p>
        <p>
          <span class="title">Quizzes completed</span> <span class="stat">{{ userStatistics.quizzesCompleted }}</span>
        </p>
        <p>
          <span class="title">Content saved</span> <span class="stat">{{ userStatistics.totalContentSaved }}</span>
        </p>

        <mat-divider></mat-divider>

        <p>
          <span class="title">Videos uploaded</span> <span class="stat">{{ userStatistics.totalVideosUploaded }}</span>
        </p>
        <p>
          <span class="title">Learning Paths uploaded</span> <span class="stat">{{ userStatistics.totalLearningPathsUploaded }}</span>
        </p>

        <mat-divider></mat-divider>

        <p>
          <span class="title">Total Comments left</span> <span class="stat">{{ userStatistics.totalCommentsLeft }}</span>
        </p>
        <p>
          <span class="title">Average Star Rating given</span> <span class="stat">{{ userStatistics.averageStarRatingGiven < 0 ? 'none' : userStatistics.averageStarRatingGiven.toFixed(1) }}</span>
        </p>
      </div>
    </ng-template>
  </div>

  @if (isExpanded) {
    <div class="content">
      @for (content of assignedContent; track content.contentId) {
        <div class="content-entry" [style.--color]="content.color" [ngClass]="content.isFinished ? 'finished' : ''">
          @if (content.type == "Video") {
            @if(content.isFinished){
              <fa-icon class="list-icon" [icon]='faCircleCheck'></fa-icon>
            } @else {
              <fa-icon class="list-icon" [icon]='faCirclePlay'></fa-icon>
            }
            <p class="title">{{ content.title }}</p>
            @if(content.isFinished){
              <p class="progress">completed</p>
            } @else{
              <p class="progress" matTooltip="{{Utils.roundNumber(content.progress, 1)}}%" matTooltipShowDelay="500">{{ Utils.roundNumber(content.progress, 1) }}% watched</p>
            }
            <p class="type">video</p>
            <p class="questions">{{content.questionOrVideoCount}} questions</p>
          } @else {
            @if(content.isFinished){
              <fa-icon class="list-icon" [icon]='faSquareCheck'></fa-icon>
            } @else {
              <app-learning-path-icon></app-learning-path-icon>
            }
            <p class="title">{{ content.title }}</p>
            @if(content.isFinished){
              <p class="progress">completed</p>
            } @else{
              <p class="progress" matTooltip="{{ content.progress }}/{{content.questionOrVideoCount}}" matTooltipShowDelay="500">{{ content.progress }}/{{content.questionOrVideoCount}} completed</p>
            }
            <p class="type">learning path</p>
            <p class="questions">{{content.questionOrVideoCount}} videos</p>
          }


          <app-icon-button (click)="unassignContent(content.contentId)" class="remove">
            @if(content.isFinished){
              <fa-icon [icon]="faX"></fa-icon>
            }@else {
              <fa-icon [icon]="faTrash"></fa-icon>
            }
          </app-icon-button>
        </div>
      }

      @if (assignedContent?.length == 0) {
        <div>
          <p class="no-results">No content yet</p>
        </div>
      }

      <input
        type="text"
        placeholder="assign content"
        [cdkMenuTriggerFor]="videoPopup"
        (input)="generateContentOptions(videoInput.value)"
        (focus)="generateContentOptions('')"
        #videoInput
      >
      <ng-template #videoPopup>
        <div class="videoOptions" cdkMenu>
          @for (content of contentOptions; track content.contentId) {
            <p (click)="assignContent(content);" class="option">
              {{ content.title }} â€¢ {{ content.type }}
            </p>
          }
          @if (contentOptions.length == 0) {
            <p class="no-results">No content found</p>
          }
        </div>
      </ng-template>
    </div>
  }
</div>

@for(subordinate of subordinates; track subordinate.userId){
  <app-manage-user-field [userTree]="subordinate" [subordinates]="subordinate.subordinates" [level]="subordinate.level"></app-manage-user-field>
}
